## promiseé¢è¯•é¢˜ï¼Ÿ

https://interview.poetries.top/qa/3-Promise%E9%9D%A2%E8%AF%95%E9%A2%98.html

##  43 é“ JavaScript é¢è¯•é¢˜ï¼Ÿ
https://juejin.cn/post/6844903869378461710

## [] == ![]ç»“æœæ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ

**ç»“æœä¸º true**

**æ¯”è¾ƒè¿ç®—ç¬¦ï¼Œå¦‚æœæŸä¸€æ–¹æ˜¯å¼•ç”¨ç±»å‹ï¼Œåˆ™ä¼šè½¬ä¸ºåŸå§‹å€¼åæ¯”è¾ƒã€‚**

**å¦‚æœéƒ½æ˜¯å¼•ç”¨ç±»å‹ï¼Œæ¯”è¾ƒå¼•ç”¨åœ°å€å³å¯ã€‚ã€‚**

1. å·¦ä¾§ç©ºæ•°ç»„`[]`ï¼Œ`[].valueOf().toString()` æ˜¯ `''` ç©ºå­—ç¬¦ä¸²
2. å³ä¾§`![] `é€»è¾‘éä¼˜å…ˆçº§ å¤§äº æ¯”è¾ƒè¿ç®—ç¬¦ï¼Œæ‰€ä»¥é¦–å…ˆæ˜¯è½¬æ¢ä¸ºå¸ƒå°”å€¼ï¼Œç”±äº`[]`ä½œä¸ºä¸€ä¸ªå¼•ç”¨ç±»å‹è½¬æ¢ä¸ºå¸ƒå°”å€¼ä¸º `true`, å› æ­¤`![]`ä¸º `false`
3. æœ€å `'' == false` åœ¨è¿›è¡Œä¸€æ¬¡éšå¼è½¬æ¢ï¼Œæ‰€ä»¥ä¸º `true`

## [] == 0 ?

**ç»“æœä¸º true**

1. `[].valueOf ().toString ()  == ''`
2. `'' == 0`

## ![] == 0 ?

**ç»“æœä¸º true**

1. ä¸€å…ƒè¿ç®—ç¬¦ä¼˜å…ˆçº§é«˜äºäºŒå…ƒè¿ç®—ç¬¦, `![] = false`
2. `false == 0`

## {} == 0 ?

**ç»“æœä¸º false**

1. `{}.valueOf ().toString ()  == '[object Object]'`
2. `[object Object]' == 0`

## !{} == 0 ?

**ç»“æœä¸º true**

1. ä¸€å…ƒè¿ç®—ç¬¦ä¼˜å…ˆçº§é«˜äºäºŒå…ƒè¿ç®—ç¬¦, `!{} = false`
2. `false == 0`

## 0 == null ?
**ç»“æœä¸º false**

å…·ä½“ç»“æœæ­¥éª¤ å‚è€ƒï¼šhttps://es6.ruanyifeng.com/#docs/spec#%E7%9B%B8%E7%AD%89%E8%BF%90%E7%AE%97%E7%AC%A6

æ€»ç»“ï¼š
- åŒç±»å‹æ¯”è¾ƒæ—¶ï¼Œæ‰§è¡Œä¸¥æ ¼ç›¸ç­‰è¿ç®— x === y
- undefined ä¸ null æ¯”è¾ƒæ—¶è¿”å› true
- string ä¸ number è¿›è¡Œæ¯”è¾ƒæ—¶ï¼Œå…ˆå°† string åš ToNumber å¤„ç†ï¼Œå†è¿›è¡Œæ¯”è¾ƒ
- boolean ä¸å…¶å®ƒç±»å‹è¿›è¡Œæ¯”è¾ƒæ—¶ï¼Œå…ˆå°† boolean åš ToNumber å¤„ç†ï¼Œå†è¿›è¡Œæ¯”è¾ƒ
- å¼•ç”¨ç±»å‹ ä¸ åŸºæœ¬ç±»å‹ è¿›è¡Œæ¯”è¾ƒæ—¶ï¼Œå°† å¼•ç”¨ç±»å‹ åš ToPrimitive å¤„ç†ï¼Œå†è¿›è¡Œæ¯”è¾ƒ
- undefined null ä¸å…¶å®ƒç±»å‹çš„æ¯”è¾ƒæ—¶éƒ½è¿”å› false


## ä¸€ä¸ªä¸­æ–‡å å¤šå°‘å­—èŠ‚ï¼Ÿ

ä¸€ä¸ªä¸­æ–‡å­—ç¬¦å ç”¨å¤šå°‘å­—èŠ‚è·Ÿç¼–ç å¯†åˆ‡ç›¸å…³ï¼Œä¸èƒ½ç›´æ¥è¯´ä¸€ä¸ªä¸­æ–‡å  2 ä¸ªæˆ–è€… 3 ä¸ªå­—èŠ‚ï¼Œæ¯”å¦‚ `UTF-8` ç¼–ç ä¸‹ä¸€ä¸ªä¸­æ–‡å­—ç¬¦é€šå¸¸å ç”¨ 3 ä¸ªå­—èŠ‚ã€‚

## ä¸€ä¸ªæ±‰å­çš„'ä¸­'.length é•¿åº¦æ˜¯å¤šå°‘ï¼Œä¸€ä¸ªè¡¨æƒ… "ğŸ˜Š".length çš„é•¿åº¦æ˜¯å¤šå°‘ï¼Œä¸ºä»€ä¹ˆï¼Ÿ

```js
"ä¸­".length; // 1
"ğŸ˜Š".length; // 2
```

åœ¨ JavaScript ä¸­ï¼Œé€šå¸¸ä½¿ç”¨ `UTF-16 `ç¼–ç ã€‚è€Œæˆ‘ä»¬çš„ç½‘é¡µé€šå¸¸æ˜¯ `UTF-8` ç¼–ç ï¼Œæ‰€ä»¥ä½¿ç”¨ javascript å†…éƒ¨çš„å­—ç¬¦ä¸²æ–¹æ³•æ—¶ï¼Œå®é™…ä¸Šå†…éƒ¨ä¼šåšä¸€ä¸ªè½¬æ¢, æ˜¯ä»¥ utf-16 ä¸ºå‡†ã€‚

é€šå¸¸ä¸€ä¸ªæ±‰å­—çš„ `length` å±æ€§æ˜¯ 1ï¼Œå› ä¸ºåœ¨ `unicode` å­—ç¬¦é›†ä¸­çš„æ•°å­—å¤§å°ï¼Œåªéœ€è¦ `utf-16` ç”¨ä¸¤ä¸ªå­—èŠ‚ä¿å­˜å³å¯ã€‚

æœ‰äº›æ•°å­—è¾ƒå¤§ï¼Œè¶…è¿‡äº†ä¸¤ä¸ªå­—èŠ‚è¡¨ç¤ºçš„èŒƒå›´ï¼Œå°±éœ€è¦ 4 ä¸ªå­—èŠ‚è¡¨ç¤ºã€‚

## ä»€ä¹ˆæ˜¯è¡¥ç ï¼Œè¡¥ç æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿï¼ˆéš¾ï¼‰

**è¡¥ç ï¼š** ä½¿ç”¨è¡¥ç è¡¨ç¤ºæ³•ï¼Œå¯ä»¥å°†å‡æ³•è½¬åŒ–ä¸ºåŠ æ³•ï¼Œè¿™æ ·åŠ æ³•å’Œå‡æ³•éƒ½å¯ä»¥åœ¨åŠ æ³•å™¨ä¸Šè¿›è¡Œè¿ç®—ï¼Œç®€åŒ–äº†è®¡ç®—æœºçš„è®¾è®¡å’Œå®ç°ã€‚
`ä¾‹å¦‚ 2 - 4 å¯ä»¥æ¢ç®—ä¸º 2 + (-4)ã€‚`

åœ¨è¡¥ç è¡¨ç¤ºæ³•ä¸­ï¼Œæ­£æ•°çš„è¡¥ç ä¸å…¶äºŒè¿›åˆ¶è¡¨ç¤ºå½¢å¼ç›¸åŒã€‚è´Ÿæ•°çš„è¡¥ç ç”±å¯¹åº”æ­£æ•°çš„è¡¥ç æŒ‰ä½å–åï¼ˆå³ 0 å˜ä¸º 1ï¼Œ1 å˜ä¸º 0ï¼‰ï¼Œç„¶åå†åŠ  1 å¾—åˆ°ã€‚

åŸºæœ¬åŸç†ï¼Œæˆ‘ä»¬æ‹¿æ—¶é’Ÿä¸¾ä¾‹ï¼š
åœ¨æ—¶é’Ÿä¸Šï¼Œæ—¶é’ˆåŠ ä¸Šï¼ˆæ­£æ‹¨ï¼‰12 çš„æ•´æ•°ä½æˆ–å‡å»ï¼ˆåæ‹¨ï¼‰12 çš„æ•´æ•°ä½ï¼Œæ—¶é’ˆçš„ä½ç½®ä¸å˜ã€‚14 ç‚¹é’Ÿåœ¨èˆå»æ¨¡ 12 åï¼Œæˆä¸ºï¼ˆä¸‹åˆï¼‰2 ç‚¹é’Ÿï¼ˆ14=14-12=2ï¼‰ã€‚ä» 0 ç‚¹å‡ºå‘é€†æ—¶é’ˆæ‹¨ 10 æ ¼å³å‡å» 10 å°æ—¶ï¼Œä¹Ÿå¯çœ‹æˆä» 0 ç‚¹å‡ºå‘é¡ºæ—¶é’ˆæ‹¨ 2 æ ¼ï¼ˆåŠ ä¸Š 2 å°æ—¶ï¼‰ï¼Œå³ 2 ç‚¹ï¼ˆ0-10=-10=-10+12=2ï¼‰ã€‚å› æ­¤ï¼Œåœ¨æ¨¡ 12 çš„å‰æä¸‹ï¼Œ-10 å¯æ˜ å°„ä¸º+2ã€‚

ä¸¾ä¾‹ï¼š
åœ¨ JavaScript ä¸­ï¼Œå¯ä»¥ä½¿ç”¨æŒ‰ä½é(~)è¿ç®—ç¬¦æ¥å®ç°å–åæ“ä½œï¼Œä½¿ç”¨æŒ‰ä½ä¸(&)è¿ç®—ç¬¦æ¥å®ç°åŠ  1 æ“ä½œã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªå®ç°å‡æ³•è¿ç®—çš„ä¾‹å­ï¼š

```js
function subtract(a, b) {
  b = ~b + 1;
  return a + b;
}
subtract(10, 8); // 2
```

## 0.1+0.2 ä¸ºä»€ä¹ˆä¸ç­‰äº 0.3ï¼Ÿå¦‚ä½•è®©å…¶ç›¸ç­‰ï¼Ÿ 0.1+0.1 ä¸ºä»€ä¹ˆç­‰äº 0.2ï¼Ÿ

> åœ¨ IEEE 754 æ ‡å‡†ä¸­ï¼Œæµ®ç‚¹æ•°çš„è¡¨ç¤ºæ˜¯æœ‰é™çš„ï¼Œ0.1 å’Œ 0.2 åœ¨è½¬æ¢æˆäºŒè¿›åˆ¶åä¼šæ— é™å¾ªç¯ï¼Œå› ä¸ºåœ¨ IEEE 754 æ ‡å‡†ä¸­çš„ 64 ä½æµ®ç‚¹æ•°çš„å°æ•°éƒ¨åˆ†ï¼Œæœ€å¤šæœ‰ 53 ä½, 2 çš„ 53 æ¬¡æ–¹å°±æ˜¯ 16 ä½æ•°å­—ï¼Œæ‰€ä»¥å°æ•°éƒ¨åˆ†æœ€å¤šå±•ç¤º 16 ä½ï¼Œç”±äºæ ‡å‡†ä½æ•°çš„é™åˆ¶åé¢å¤šä½™çš„ä½æ•°ä¼šè¢«æˆªæ‰ï¼Œæ­¤æ—¶å°±å·²ç»å‡ºç°äº†ç²¾åº¦çš„æŸå¤±ï¼Œç›¸åŠ åå› æµ®ç‚¹æ•°å°æ•°ä½çš„é™åˆ¶è€Œæˆªæ–­çš„äºŒè¿›åˆ¶æ•°å­—åœ¨è½¬æ¢ä¸ºåè¿›åˆ¶å°±ä¼šå˜æˆ 0.30000000000000004

**<font color="red">æ‰€ä»¥ 0.1+0.2 ä¸ç­‰äº 0.3</font>**

```js
(0.1).toPrecision(16); // "0.1000000000000000"
(0.1).toPrecision(17); // "0.10000000000000001";
```

**<font color="red">æ‰€ä»¥ 0.1 + 0.1 æ­£å¥½ 16 ä½ï¼ˆå››èˆäº”å…¥ï¼‰æˆªæ–­ï¼Œç­‰äº 0.2ã€‚</font>**

**è§£å†³åŠæ³•ï¼š**

**ES6 æä¾›çš„ Number.EPSILON å¸¸é‡**

Number.EPSILON çš„å®è´¨æ˜¯ä¸€ä¸ªå¯ä»¥æ¥å—çš„æœ€å°è¯¯å·®èŒƒå›´ï¼Œä¸€èˆ¬æ¥è¯´ä¸º `Math.pow(2, -52)`

```js
function isEqual(a, b) {
  return Math.abs(a - b) < Number.EPSILON;
}

console.log(isEqual(0.1 + 0.2, 0.3)); // true
```

**ä¹˜ä»¥ä¸€ä¸ª 10 çš„å¹‚æ¬¡æ–¹**

æŠŠéœ€è¦è®¡ç®—çš„æ•°å­—ä¹˜ä»¥ 10 çš„ n æ¬¡æ–¹ï¼Œè®©æ•°å€¼éƒ½å˜ä¸ºæ•´æ•°ï¼Œè®¡ç®—å®Œåå†é™¤ä»¥ 10 çš„ n æ¬¡æ–¹ï¼Œè¿™æ ·å°±ä¸ä¼šå‡ºç°æµ®ç‚¹æ•°ç²¾åº¦ä¸¢å¤±é—®é¢˜

```js
(0.1 * 10 + 0.2 * 10) / 10 == 0.3; //true
```

## å¦‚ä½•è®© if(a == 1 && a == 2)æ¡ä»¶æˆç«‹ï¼Ÿ

æ¶‰åŠåˆ°éšå¼ç±»å‹è½¬æ¢ï¼Œå¯¹è±¡è½¬æ¢æˆåŸºæœ¬æ•°æ®ç±»å‹ä¼šè°ƒç”¨å†…ç½®çš„`[ToPrimitive]`å‡½æ•°ï¼Œå¯¹äºè¯¥å‡½æ•°è€Œè¨€ï¼Œå…¶é€»è¾‘å¦‚ä¸‹ï¼š

- å¦‚æœæœ‰ `Symbol.toPrimitive()`æ–¹æ³•ï¼Œä¼˜å…ˆè°ƒç”¨å†è¿”å›
- è°ƒç”¨ `valueOf()`ï¼Œå¦‚æœè½¬æ¢ä¸ºåŸå§‹ç±»å‹ï¼Œåˆ™è¿”å›
- è°ƒç”¨ `toString()`ï¼Œå¦‚æœè½¬æ¢ä¸ºåŸå§‹ç±»å‹ï¼Œåˆ™è¿”å›
- å¦‚æœéƒ½æ²¡æœ‰è¿”å›åŸå§‹ç±»å‹ï¼Œä¼šæŠ¥é”™

```js
let obj = {
  value: 3,
  valueOf() {
    return 4;
  },
  toString() {
    return "5";
  },
  [Symbol.toPrimitive]() {
    return 6;
  },
};
console.log(obj + 1); // è¾“å‡º7
```

æ‰€ä»¥å¯ä»¥ä½¿ç”¨ **é‡å†™/è¦†ç›–** ä»¥ä¸Šä»»ä½•ä¸€ä¸ª æ–¹æ³•å³å¯

```js
let a = {
  value: 0,
  valueOf: function () {
    this.value++;
    return this.value;
  },
};
console.log(a == 1 && a == 2); // true
```

## ä»¥ä¸‹ä»£ç çš„ console.log(2); ä¼šæ‰§è¡Œå—ï¼Œä»€ä¹ˆæ—¶å€™æ‰§è¡Œï¼Ÿ

```js
new Promise((resolve, reject) => {
  resolve(1);
  console.log(2);
}).then((res) => {
  console.log(res);
});
```

::: details
ä¼šæ‰§è¡Œï¼Œæ‰§è¡Œé¡ºåºæ˜¯ï¼š2ã€1

è¿™æ˜¯å› ä¸ºç«‹å³ `resolved` çš„ `Promise` æ˜¯åœ¨æœ¬è½®äº‹ä»¶å¾ªç¯çš„æœ«å°¾æ‰§è¡Œï¼Œæ€»æ˜¯æ™šäºæœ¬è½®å¾ªç¯çš„åŒæ­¥ä»»åŠ¡ã€‚
:::

## ä»¥ä¸‹ä»£ç çš„ console.log(2); ä¼šæ‰§è¡Œå—ï¼Œä»€ä¹ˆæ—¶å€™æ‰§è¡Œï¼Ÿ

```js
new Promise((resolve, reject) => {
  return resolve(1);
  console.log(2);
}).then((res) => {
  console.log(res);
});
```

::: details
ä¸ä¼šæ‰§è¡Œï¼Œå› ä¸ºæœ‰ return
:::

## ä»¥ä¸‹ä»£ç çš„æ‰§è¡Œé¡ºåºï¼Œä¸ºä»€ä¹ˆï¼Ÿ

```js
let promise = new Promise(function (resolve, reject) {
  console.log("Promise");
  resolve();
});

promise.then(function () {
  console.log("resolved.");
});

setTimeout(function () {
  console.log("setTimeout");
});

console.log("Hi!");
```

::: details

1. åˆ›å»º promise å®ä¾‹ï¼Œæ˜¯ä¸€ä¸ªåŒæ­¥æ“ä½œï¼Œä¼šç«‹å³æ‰§è¡Œï¼Œæ‰“å°ï¼š`Promise`
2. é‡åˆ° promise ç»“æœæ˜¯ä¸€ä¸ªå¾®ä»»åŠ¡ï¼Œæ”¾åˆ°å½“å‰çš„å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œä¸‹è¾¹é‡åˆ° setTimeout æ˜¯ä¸€ä¸ªå®ä»»åŠ¡ï¼Œæ”¾åˆ°å®ä»»åŠ¡é˜Ÿåˆ—ï¼Œç„¶åæ‰§è¡ŒåŒæ­¥ä»£ç  console.log('Hi!')ï¼Œæ‰“å°ï¼š`Hi!`
3. åŒæ­¥ä»£ç æ‰§è¡Œå®Œæ¯•åï¼Œæ‰§è¡Œå¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œæ‰“å°ï¼š`resolved.`
4. å¾®ä»»åŠ¡æ‰§è¡Œå®Œï¼Œæ‰§è¡Œå®ä»»åŠ¡é˜Ÿåˆ—ï¼Œæ‰“å°ï¼š`setTimeout`

```js
// æ‰“å°ï¼š
// Promise
// Hi!
// resolved.
// setTimeout
```

:::

## ä»¥ä¸‹ä»£ç  æ‰“å°ä»€ä¹ˆï¼Ÿ

```js
const p1 = new Promise(function (resolve, reject) {
  setTimeout(() => reject(new Error("fail")), 3000);
});

const p2 = new Promise(function (resolve, reject) {
  setTimeout(() => resolve(p1), 1000);
});

p2.then((result) => console.log(result)).catch((error) => console.log(error));
```

::: details
**æ‰“å° `Error: fail`**

`p1` æ˜¯ä¸€ä¸ª Promiseï¼Œ3 ç§’ä¹‹åå˜ä¸º`rejected`ã€‚`p2`çš„çŠ¶æ€åœ¨ 1 ç§’ä¹‹åæ”¹å˜ï¼Œ`resolve`æ–¹æ³•è¿”å›çš„æ˜¯`p1`ã€‚ç”±äº`p2`è¿”å›çš„æ˜¯å¦ä¸€ä¸ª Promiseï¼Œå¯¼è‡´`p2`è‡ªå·±çš„çŠ¶æ€æ— æ•ˆäº†ï¼Œç”±`p1`çš„çŠ¶æ€å†³å®š`p2`çš„çŠ¶æ€ã€‚æ‰€ä»¥ï¼Œåé¢çš„`then`è¯­å¥éƒ½å˜æˆé’ˆå¯¹åè€…ï¼ˆ`p1`ï¼‰ã€‚åˆè¿‡äº† 2 ç§’ï¼Œ`p1`å˜ä¸º`rejected`ï¼Œå¯¼è‡´è§¦å‘`catch`æ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°ã€‚
:::

## å¯ä»¥æ•è·åˆ°è¿™ä¸ªé”™è¯¯å—(å¦‚ä½•æ•è· promise å†…éƒ¨çš„é”™è¯¯)ï¼Ÿ

```js
try {
  const promise = new Promise(function (resolve, reject) {
    throw new Error("test");
  });
} catch (e) {
  console.log(e, "catch");
}
```

::: details
ä¸å¯ä»¥ï¼Œå¤–éƒ¨æ— æ³•æ•è·åˆ° promise å†…éƒ¨çš„é”™è¯¯ã€‚

å¯ä»¥ä»¥ä¸‹æ–¹å¼è§£å†³ï¼š

```js
// å†™æ³•ä¸€
const promise = new Promise(function (resolve, reject) {
  try {
    throw new Error("test");
  } catch (e) {
    reject(e);
  }
});
promise.catch(function (error) {
  console.log(error);
});

// å†™æ³•äºŒ
const promise = new Promise(function (resolve, reject) {
  reject(new Error("test"));
});
promise.catch(function (error) {
  console.log(error);
});
```

:::

## æ‰“å°ä»€ä¹ˆï¼Ÿ

```js
const promise = new Promise(function (resolve, reject) {
  resolve("ok");
  throw new Error("test");
});
promise
  .then(function (value) {
    console.log(value);
  })
  .catch(function (error) {
    console.log(error);
  });
```

::: details
**<font color="red">æ‰“å° ok</font>**

`Promise` åœ¨ `resolve` è¯­å¥åé¢ï¼Œå†æŠ›å‡ºé”™è¯¯ï¼Œä¸ä¼šè¢«æ•è·ï¼Œç­‰äºæ²¡æœ‰æŠ›å‡ºã€‚å› ä¸º `Promise` çš„çŠ¶æ€ä¸€æ—¦æ”¹å˜ï¼Œå°±æ°¸ä¹…ä¿æŒè¯¥çŠ¶æ€ï¼Œä¸ä¼šå†å˜äº†ã€‚

:::

## ä»¥ä¸‹ä»£ç å¯ä»¥æ•è·å‰é¢ promise çš„é”™è¯¯ä¹ˆï¼Ÿ

```js
getJSON("/post/1.json")
  .then(function (post) {
    return getJSON(post.commentURL);
  })
  .then(function (comments) {
    // some code
  })
  .catch(function (error) {
    // å¯ä»¥ æ•è·åˆ° å‰é¢ä¸‰ä¸ªPromiseäº§ç”Ÿçš„é”™è¯¯å—ï¼Ÿ
  });
```

::: details
**<font color="red">å¯ä»¥</font>**

`Promise` å¯¹è±¡çš„é”™è¯¯å…·æœ‰<font color="red">â€œå†’æ³¡â€</font>æ€§è´¨ï¼Œä¼šä¸€ç›´å‘åä¼ é€’ï¼Œç›´åˆ°è¢«æ•è·ä¸ºæ­¢ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œé”™è¯¯æ€»æ˜¯ä¼šè¢«ä¸‹ä¸€ä¸ª`catch`è¯­å¥æ•è·ã€‚

ä¸Šé¢ä»£ç ä¸­ï¼Œä¸€å…±æœ‰ä¸‰ä¸ª `Promise` å¯¹è±¡ï¼šä¸€ä¸ªç”±`getJSON()`äº§ç”Ÿï¼Œä¸¤ä¸ªç”±`then()`äº§ç”Ÿã€‚å®ƒä»¬ä¹‹ä¸­ä»»ä½•ä¸€ä¸ªæŠ›å‡ºçš„é”™è¯¯ï¼Œéƒ½ä¼šè¢«æœ€åä¸€ä¸ª`catch()`æ•è·ã€‚

> ä¸è¦åœ¨ then()æ–¹æ³•é‡Œé¢å®šä¹‰ Reject çŠ¶æ€çš„å›è°ƒå‡½æ•°ï¼ˆå³ then çš„ç¬¬äºŒä¸ªå‚æ•°ï¼‰ï¼Œæ€»æ˜¯ä½¿ç”¨ catch æ–¹æ³•ã€‚è¿™æ ·å°±å¯ä»¥æ•è·åˆ°å‰é¢æ‰€æœ‰çš„ promise é”™è¯¯ã€‚

:::

## ä»¥ä¸‹ Promise.all çš„ catch æ–¹æ³•èƒ½æ•è·åˆ° p2 çš„é”™è¯¯å—ï¼Ÿ

```js
const p1 = new Promise((resolve, reject) => {
  resolve("hello");
})
  .then((result) => result)
  .catch((e) => e);

const p2 = new Promise((resolve, reject) => {
  throw new Error("æŠ¥é”™äº†");
})
  .then((result) => result)
  .catch((e) => e);

Promise.all([p1, p2])
  .then((result) => console.log(result))
  .catch((e) => console.log(e)); // è¿™é‡Œå¯ä»¥æ•è·åˆ° p2çš„é”™è¯¯å—ï¼Ÿ
```

::: details
**<font color="red">ä¸å¯ä»¥</font>**

ä¸Šé¢ä»£ç ä¸­ï¼Œ`p1`ä¼š`resolved`ï¼Œ`p2`é¦–å…ˆä¼š`rejected`ï¼Œä½†æ˜¯`p2`æœ‰è‡ªå·±çš„`catch`æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ªæ–°çš„ `Promise` å®ä¾‹ï¼Œ`p2`æŒ‡å‘çš„å®é™…ä¸Šæ˜¯è¿™ä¸ªå®ä¾‹ã€‚è¯¥å®ä¾‹æ‰§è¡Œå®Œ`catch`æ–¹æ³•åï¼Œä¹Ÿä¼šå˜æˆ`resolved`ï¼Œå¯¼è‡´`Promise.all()`æ–¹æ³•å‚æ•°é‡Œé¢çš„ä¸¤ä¸ªå®ä¾‹éƒ½ä¼š`resolved`ï¼Œå› æ­¤ä¼šè°ƒç”¨`then`æ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°ï¼Œè€Œä¸ä¼šè°ƒç”¨`catch`æ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°ã€‚

æœ€åæ‰“å°ï¼š`["hello", Error: æŠ¥é”™äº†]`

:::

## ä»¥ä¸‹ Promise.all çš„ catch æ–¹æ³•èƒ½æ•è·åˆ° p2 çš„é”™è¯¯å—ï¼Ÿ

```js
const p1 = new Promise((resolve, reject) => {
  resolve("hello");
}).then((result) => result);

const p2 = new Promise((resolve, reject) => {
  throw new Error("æŠ¥é”™äº†");
}).then((result) => result);

Promise.all([p1, p2])
  .then((result) => console.log(result))
  .catch((e) => console.log(e)); // è¿™é‡Œå¯ä»¥æ•è·åˆ° p2çš„é”™è¯¯å—ï¼Ÿ
```

::: details
**<font color="red">å¯ä»¥</font>**

å’Œä¸Šè¾¹çš„é¢˜ä¸€æ ·ï¼Œåªä¸è¿‡`p2`æ²¡æœ‰è‡ªå·±çš„`catch`æ–¹æ³•ï¼Œå°±ä¼šè°ƒç”¨`Promise.all()`çš„`catch`æ–¹æ³•ã€‚

:::

## ä»¥ä¸‹ä»£ç æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

```js
// ä»£ç ä¸€
let foo = await getFoo();
let bar = await getBar();

// ä»£ç äºŒ
let [foo, bar] = await Promise.all([getFoo(), getBar()]);

// ä»£ç ä¸‰
let fooPromise = getFoo();
let barPromise = getBar();
let foo = await fooPromise;
let bar = await barPromise;
```

::: details

**ä»£ç ä¸€**

`getFoo`å’Œ`getBar`æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„å¼‚æ­¥æ“ä½œï¼ˆå³äº’ä¸ä¾èµ–ï¼‰ï¼Œè¢«å†™æˆç»§å‘å…³ç³»ã€‚è¿™æ ·æ¯”è¾ƒè€—æ—¶ï¼Œå› ä¸ºåªæœ‰`getFoo`å®Œæˆä»¥åï¼Œæ‰ä¼šæ‰§è¡Œ`getBar`ï¼Œå®Œå…¨å¯ä»¥è®©å®ƒä»¬åŒæ—¶è§¦å‘ã€‚

**ä»£ç äºŒ å’Œ ä»£ç ä¸‰**

`getFoo`å’Œ`getBar` å¹¶å‘è§¦å‘ï¼Œè¿™æ ·å°±ä¼šç¼©çŸ­ç¨‹åºçš„æ‰§è¡Œæ—¶é—´

:::

## ä¸‹è¾¹ä»£ç ä¾æ¬¡æ‰“å°ä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆï¼Ÿ

```html
<script type="text/javascript">
  console.log("ç¬¬ä¸€ä¸ªè„šæœ¬ beginã€‚ã€‚ã€‚");

  Promise.resolve().then((res) => {
    console.log("ç¬¬ä¸€ä¸ªè„šæœ¬ promise");
  });

  console.log("ç¬¬ä¸€ä¸ªè„šæœ¬ endã€‚ã€‚ã€‚");
</script>

<script type="text/javascript">
  console.log("ç¬¬äºŒä¸ªè„šæœ¬ beginã€‚ã€‚ã€‚");

  Promise.resolve().then((res) => {
    console.log("ç¬¬äºŒä¸ªè„šæœ¬ promise");
  });
  console.log("ç¬¬äºŒä¸ªè„šæœ¬ endã€‚ã€‚ã€‚");
</script>
```

::: details
ä¾æ¬¡æ‰“å°ï¼š

- ç¬¬ä¸€ä¸ªè„šæœ¬ beginã€‚ã€‚ã€‚
- ç¬¬ä¸€ä¸ªè„šæœ¬ endã€‚ã€‚ã€‚
- ç¬¬ä¸€ä¸ªè„šæœ¬ promise
- ç¬¬äºŒä¸ªè„šæœ¬ beginã€‚ã€‚ã€‚
- ç¬¬äºŒä¸ªè„šæœ¬ endã€‚ã€‚ã€‚
- ç¬¬äºŒä¸ªè„šæœ¬ promise

å®é™…ä¸Šå¦‚æœåŒæ—¶å­˜åœ¨ä¸¤ä¸ª `script` ä»£ç å—ï¼Œä¼šé¦–å…ˆåœ¨æ‰§è¡Œç¬¬ä¸€ä¸ª `script` ä»£ç å—ä¸­çš„åŒæ­¥ä»£ç ï¼Œå¦‚æœè¿™ä¸ªè¿‡ç¨‹ä¸­åˆ›å»ºäº†å¾®ä»»åŠ¡å¹¶è¿›å…¥äº†å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œç¬¬ä¸€ä¸ª `script` åŒæ­¥ä»£ç æ‰§è¡Œå®Œä¹‹åï¼Œä¼šé¦–å…ˆå»æ¸…ç©ºå¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œå†å»å¼€å¯ç¬¬äºŒä¸ª `script` ä»£ç å—çš„æ‰§è¡Œã€‚**æ‰€ä»¥è¿™é‡Œåº”è¯¥å°±å¯ä»¥ç†è§£ `script`ï¼ˆæ•´ä½“ä»£ç å—ï¼‰ä¸ºä»€ä¹ˆä¼šæ˜¯å®ä»»åŠ¡ã€‚**

:::

## ä»¥ä¸‹æ‰“å°é¡ºåºï¼Ÿ

```js
setTimeout(() => {
    console.log('timeout')
}, 0)                                       

new Promise(resolve => {
    console.log('new Promise')              
    resolve()
}).then(() => {
   console.log('Promise then')             
}).then(() => {
        console.log('Promise then then')   
})

console.log('hi')
```

## ä»¥ä¸‹æ‰“å°é¡ºåºï¼Ÿ

```js
console.log("1", Date.now());

const p = new Promise((resolve, reject) => {
  console.log("2", Date.now());

  setTimeout(() => {
    console.log("3", Date.now());
    resolve("finished");
  }, 500);

  setTimeout(() => {
    console.log("5", Date.now());
    resolve("finished");
  }, 600);
});

p.then(
  (data) => {
    console.log(data);
    console.log("4", Date.now());
  },
  (err) => {
    console.log(err);
    console.log("6", Date.now());
  }
);
```
:::details
æ³¨æ„ä¸¤ä¸ªç‚¹ï¼š

1ï¸âƒ£ rejectæ˜¯å¦ä¼šæ‰§è¡Œï¼Ÿï¼ˆPromiseçš„çŠ¶æ€å˜ä¸ºfulfilledï½œrejectedï¼Œå°±æ— æ³•æ”¹å˜ï¼‰

2ï¸âƒ£ .thenä¸­çš„ä»£ç ä¸€å®šæ˜¯Promiseçš„çŠ¶æ€å·²ç»å˜ä¸ºfulfilledï½œrejectedäº†æ‰ä¼šæ‰§è¡Œï¼Œå¹¶ä¸”ä¼šæ ¹æ®å…·ä½“çŠ¶æ€æ‹©ä¸€æ‰§è¡Œ

:::